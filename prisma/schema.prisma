generator client {
  provider        = "prisma-client-js"
  output          = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ─── Enums ───────────────────────────────────────────────

enum BodyType {
  SEDAN
  SUV
  TRUCK
  WAGON
  COUPE
  VAN
}

enum VehicleCondition {
  EXCELLENT
  GOOD
  FAIR
}

enum VehicleStatus {
  ACTIVE
  INCOMING
  IN_RECON
  SOLD
  DELETED
}

enum LeadSource {
  WEBSITE
  CHAT
  PHONE
  WALKIN
  CARGURUS
  FACEBOOK
}

enum LeadStatus {
  NEW
  CONTACTED
  APPOINTMENT_SET
  SHOWED
  SOLD
  LOST
}

enum AppointmentType {
  TEST_DRIVE
  CONSULTATION
  FINANCE_REVIEW
}

enum AppointmentStatus {
  SCHEDULED
  CONFIRMED
  COMPLETED
  NO_SHOW
  CANCELLED
}

enum FinanceStatus {
  SUBMITTED
  UNDER_REVIEW
  APPROVED
  DENIED
}

enum UserRole {
  ADMIN
  SALES
  VIEWER
}

enum ChatRole {
  USER
  ASSISTANT
}

// ─── Models ──────────────────────────────────────────────

model Vehicle {
  id            String           @id @default(cuid())
  vin           String           @unique
  stockNumber   String?          @unique
  year          Int
  make          String
  model         String
  trim          String?
  bodyType      BodyType
  exteriorColor String?
  interiorColor String?
  mileage       Int
  engine        String?
  transmission  String?
  drivetrain    String?
  price         Float
  internetPrice Float?
  bookValue     Float?
  condition     VehicleCondition @default(GOOD)
  status        VehicleStatus    @default(ACTIVE)
  description   String?
  features      Json             @default("[]")
  carfaxUrl     String?
  autoCheckUrl  String?
  dealerCenterId String?
  slug          String           @unique
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt
  soldAt        DateTime?

  photos              VehiclePhoto[]
  leads               Lead[]
  appointments        Appointment[]
  financeApplications FinanceApplication[]

  @@index([status])
  @@index([bodyType])
  @@index([make])
  @@index([price])
  @@index([year])
}

model VehiclePhoto {
  id          String  @id @default(cuid())
  vehicleId   String
  url         String
  supabasePath String?
  sortOrder   Int     @default(0)
  isPrimary   Boolean @default(false)
  alt         String?

  vehicle Vehicle @relation(fields: [vehicleId], references: [id], onDelete: Cascade)

  @@index([vehicleId])
}

model Lead {
  id             String     @id @default(cuid())
  firstName      String
  lastName       String?
  email          String?
  phone          String?
  source         LeadSource @default(WEBSITE)
  status         LeadStatus @default(NEW)
  message        String?
  assignedToId   String?
  vehicleId      String?
  adfPushed      Boolean    @default(false)
  adfPushedAt    DateTime?
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt

  assignedTo     User?        @relation(fields: [assignedToId], references: [id])
  vehicle        Vehicle?     @relation(fields: [vehicleId], references: [id])
  notes          LeadNote[]
  appointments   Appointment[]
  conversations  ChatConversation[]
  financeApplications FinanceApplication[]

  @@index([status])
  @@index([source])
  @@index([assignedToId])
  @@index([createdAt])
}

model LeadNote {
  id        String   @id @default(cuid())
  leadId    String
  authorId  String
  content   String
  createdAt DateTime @default(now())

  lead   Lead @relation(fields: [leadId], references: [id], onDelete: Cascade)
  author User @relation(fields: [authorId], references: [id])

  @@index([leadId])
}

model Appointment {
  id            String            @id @default(cuid())
  leadId        String
  vehicleId     String?
  type          AppointmentType
  date          DateTime
  startTime     String
  endTime       String?
  status        AppointmentStatus @default(SCHEDULED)
  notes         String?
  reminderSentAt DateTime?
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt

  lead    Lead     @relation(fields: [leadId], references: [id])
  vehicle Vehicle? @relation(fields: [vehicleId], references: [id])

  @@index([date])
  @@index([leadId])
  @@index([status])
}

model FinanceApplication {
  id                   String        @id @default(cuid())
  leadId               String?
  firstName            String
  lastName             String
  email                String
  phone                String
  dateOfBirth          String?
  ssnEncrypted         String?
  employmentStatus     String?
  monthlyIncome        Float?
  housingStatus        String?
  monthlyHousingPayment Float?
  vehicleId            String?
  status               FinanceStatus @default(SUBMITTED)
  createdAt            DateTime      @default(now())

  lead    Lead?    @relation(fields: [leadId], references: [id])
  vehicle Vehicle? @relation(fields: [vehicleId], references: [id])

  @@index([status])
  @@index([createdAt])
}

model User {
  id           String    @id @default(cuid())
  email        String    @unique
  supabaseId   String?   @unique
  name         String
  role         UserRole  @default(VIEWER)
  passwordHash String
  avatar       String?
  isActive     Boolean   @default(true)
  createdAt    DateTime  @default(now())
  lastLoginAt  DateTime?

  assignedLeads Lead[]
  notes         LeadNote[]
  sessions      Session[]
}

model Session {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([expiresAt])
}

model Page {
  id              String    @id @default(cuid())
  slug            String    @unique
  title           String
  content         String?
  metaTitle       String?
  metaDescription String?
  publishedAt     DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
}

model ChatConversation {
  id        String   @id @default(cuid())
  sessionId String
  leadId    String?
  createdAt DateTime @default(now())

  lead     Lead?         @relation(fields: [leadId], references: [id])
  messages ChatMessage[]

  @@index([sessionId])
  @@index([createdAt])
}

model ChatMessage {
  id             String   @id @default(cuid())
  conversationId String
  role           ChatRole
  content        String
  createdAt      DateTime @default(now())

  conversation ChatConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
}
